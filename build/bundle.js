"use strict";
module.exports=function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){var o=n(1);const r=n(2),s=n(3),i=n(4),{JWK:c,JWE:a}=n(5),{SignJWT:u,importJWK:d,importPKCS8:l,jwtVerify:I,createRemoteJWKSet:g}=n(6),E=n(7),p=n(8),y=n(9),A=n(10),{KeyObject:N}=n(11);A.config();const f=r();f.use(r.json()),f.use(r.urlencoded({extended:!0})),f.get("/.well-known/keys",async(e,t)=>{t.json(s)}),f.get("/jwks",async(e,t)=>{t.json(i)}),e.exports=o.fromExpress(f),f.post("/token",async(e,t)=>{const n=e.webtaskContext?e.webtaskContext.data:Object({NODE_ENV:"production",CLIENT_VERSION:"1.4.0"});console.log(e.body);const{client_id:o,code:r,code_verifier:i,redirect_uri:A}=e.body;if(!o)return t.status(400).send("Missing client_id");if(n.IDP_CLIENT_ID!==o)return t.status(401).send("Invalid request, client_id is incorrect!");try{const e=await async function(e){try{const t=await async function(e){try{var t=s.keys.find(e=>"sig"===e.use);return t.d=e.RELYING_PARTY_PRIVATE_KEY_SIGNING,await d(t,e.RELYING_PARTY_CLIENT_ASSERTION_SIGNING_ALG)}catch(e){return e}}(e);console.log(t);const n=await new u({}).setProtectedHeader({alg:e.RELYING_PARTY_CLIENT_ASSERTION_SIGNING_ALG,kid:e.RELYING_PARTY_KID,typ:"JWT"}).setIssuedAt().setIssuer(e.IDP_CLIENT_ID).setSubject(e.IDP_CLIENT_ID).setAudience([`https://${e.IDP_DOMAIN}/`,`https://${e.IDP_DOMAIN}/token`]).setExpirationTime("2m").setJti(p.v4()).sign(t);return console.log(n),n}catch(e){return console.log(e),e}}(n);console.log(e);const o={method:"POST",url:`https://${n.IDP_DOMAIN}/token`,headers:{"content-type":"application/x-www-form-urlencoded"},data:y.stringify({grant_type:"authorization_code",client_id:n.IDP_CLIENT_ID,client_assertion_type:"urn:ietf:params:oauth:client-assertion-type:jwt-bearer",client_assertion:e,code:r,code_verifier:i,redirect_uri:A})},f=await E.request(o);console.log(f.data);const{id_token:_}=f.data,P=await async function(e,t){var n=s.keys.find(e=>"enc"===e.use&&e.alg===t.RELYING_PARTY_PRIVATE_KEY_ENC_ALG);if(!n)return console.log("Either not encrypted or the right key is not available!, returning token as is!"),e;n.d=t.RELYING_PARTY_PRIVATE_KEY_ENC;try{const t=a.createDecrypt(await c.asKey(n,"json")),o=await t.decrypt(e),r=o.plaintext.toString("utf8");return console.log(r),r}catch(e){throw console.log(e),e}}(_,n),D=g(new URL(`https://${n.IDP_DOMAIN}/jwks`)),{payload:S,protectedHeader:k}=await I(P,D,{issuer:`https://${n.IDP_DOMAIN}`,audience:n.IDP_CLIENT_ID});console.log(S),console.log(k),S.nonce&&delete S.nonce,f.data.payload=S,delete f.data.id_token;const w=await async function(e,t){e.nonce&&delete e.nonce;try{const n="-----BEGIN PRIVATE KEY-----\nMIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQC/s+Jg6d1vXEjS\n8Vpe1DslbrqWtFt4WuPSEUvfNgQyCxyMGDkp8bYS3BqTxbjUBDPZ5YA6EO1fjZrx\nNvsPnXG4SkUcGgSo6gsHU2xTknW/W7EUZQZPSD+8xM3sxTEFTN2CGIjVrdO6BmxO\ndANdPhHSaxBTWEKLvJeg8RMH4BBv/SuJ8FgreSDB4ZnmEU6+S7L59mKEkas0SgC3\nf/Xt0SLy4CiqIAA3hc+nPgyZiLME2NjTKQUrCj5JZ254d7oWfAmR5Zg3M80WMG9q\nIc/tJjI+w9ypX9zdLWNQez156rnUaIpG6jMtFTaS0M/3j/5+irB9jRqKTbEqRhw3\nsrj8yzg3AgMBAAECggEAK3kRp0ShsLVO1ndhNQwP9acsrSxtadfCvkqp2A6Z2Pdo\nG+UKYZas4Y4EgOpfxcTGNW20LHbWPcsRDg6X1Kyxs0c0cPD9iYi5w4mJkVIvXZvf\nhm56hdQukBJZWI5HVZpeyTfjIAHxd8gpG4l3kdeXlw4sf5oOTT4RbK/+ztRjJeHx\nUxqnzYgXGUWY0wM9rRsJzj3vL/zi4L3Xx47GFQGgbVAnBO+wg7wwDEKgiVEStP9P\nTbXUX8wuIX8t9DVRlMOcPjksDBULepKjeK3ljkORAEuIzjeSYYxwvSQmGIdotwcE\n9+KXL/nlGo4hMhEULGSzWHtCFeLvHvWQKP91brMl4QKBgQDiraU1ZbJPyTmNHz6q\nPmYo0Oi+956yNAKVaAwDPwqN2d13PRzW4sMb0P54ZFXdxo0Jo1w7k2nGr1QUcjPF\nUdaNm7PzeA5w5m5yv5LfPGdePSv8h1ZlspST/b02QVDpKGKHTzym/d10V4cr2NYB\nVOgAODqRatP2utBlbTGS4rB2eQKBgQDYgAk3gicPO+QyzJv+GUqZ4dCIrkLh5DCJ\nBE6t0gX7DehVN9fmv6XNbP27EZVt5CyF9loRDHArTNDEy+J/+vQ4X4S7om4Xmkan\ne4KaWvHlZ++RJIubu7jGVsH3+36cyEb8IXlEnxf6GijiF7p3ktTjGVp739QKHuc+\nK8OhZZM4LwKBgAHDlCuMNQ0F5drBSX2NqsHajlUeHDAK05JSEvXbgbuE3IJXCWhq\nr1YCFFjffwOQzfwrN0aHaSVQq/jUwq5gaqkDcy0L3CDoyic+cmgmUi+bjkIS04tL\nDnjwWo6Xh4eo9stSxIgQJa8IF1cyAshT3tJRnbMP/8JFxeVkKiSYewMRAoGADy+j\n9d3OSZZE4n9RrdguUG7zhrLahCfSc7n2nuCthLesBVY+cbQduDQd9CI+ng+0Q81M\n8gcyUwc3WaaHg7yhptakY9j36fXrYNIcDiG0+Ad7WW370Pew9VCemHtunSa7O/JJ\nJFQYhXWSSpGphbup7SgZHblMkU0roUPGnCqY0gcCgYAu3PBaK22IMQwKpbVY5yHg\nz0mfNx8uMLPaUEVOUaiIXoLGc4RB48p+ZNnvArstWLmeFIeH48CQ2sGE0y3gAQZQ\nnQMH3YUwicCeSdqv8YIrrssLtsyjklEuBWQY1d4MOlbJYS+BeK2phjOPB8tQPkwV\niiCJHk5cUt1Nr+Z/ISmz/Q==\n-----END PRIVATE KEY-----\n".replace(/\n/g,"\r\n");console.log(n);const o=await l(n,t.INTERMEDIARY_SIGNING_ALG,{use:"sig"});console.log(o);const r=N.from(o),s=await new u(e).setProtectedHeader({alg:t.INTERMEDIARY_SIGNING_ALG,kid:t.INTERMEDIARY_KEY_KID,typ:"JWT"}).setIssuedAt().setIssuer(`https://${t.IDP_DOMAIN}`).setAudience(t.IDP_CLIENT_ID).setExpirationTime("2m").setJti(p.v4()).sign(r);return console.log(s),s}catch(e){return console.log(e),e}}(S,n);return f.data.id_token=w,t.status(200).send(f.data)}catch(e){return e.response?t.status(e.response.status).send(e.response.data):(console.error("Error:",e.message),t.status(500).send(e.message))}})},function(e,t){e.exports=require("webtask-tools")},function(e,t){e.exports=require("express@4.17.1")},function(e){e.exports=JSON.parse('{"keys":[{"kty":"EC","kid":"Al93ssyWpZ2yOoLxbDohuTigc1i5XNt1PKMyvU8aVgY","use":"sig","crv":"P-256","x":"6-l6udWD4kVDnoa8xDYNf9GHJXQXTNPEU8qfkiFHCBE","y":"TTXy1kprqhMA7bRy9v14C741tkOXkU36OtOuTKx6X80"},{"kty":"EC","kid":"UAzl2k6tGnj0bJBh5AimmGVd68QDrNyc9UTADv6dcc8","use":"enc","alg":"ECDH-ES+A128KW","crv":"P-256","x":"VexWR3Lb2dmnzuZeSNzS58XtM6bFpJOr2QN-p_WKN48","y":"7x7Vywcy8qZqE3SIaP-K7FAgrCECKJ_xoxr-zc6Wi4Y"}]}')},function(e){e.exports=JSON.parse('{"keys":[{"kty":"RSA","use":"sig","kid":"QVBKtPRpC9s2cynBuEI7DMjXwtinIkdMQ-ZMUX2BKZg","n":"v7PiYOndb1xI0vFaXtQ7JW66lrRbeFrj0hFL3zYEMgscjBg5KfG2Etwak8W41AQz2eWAOhDtX42a8Tb7D51xuEpFHBoEqOoLB1NsU5J1v1uxFGUGT0g_vMTN7MUxBUzdghiI1a3TugZsTnQDXT4R0msQU1hCi7yXoPETB-AQb_0rifBYK3kgweGZ5hFOvkuy-fZihJGrNEoAt3_17dEi8uAoqiAAN4XPpz4MmYizBNjY0ykFKwo-SWdueHe6FnwJkeWYNzPNFjBvaiHP7SYyPsPcqV_c3S1jUHs9eeq51GiKRuozLRU2ktDP94_-foqwfY0aik2xKkYcN7K4_Ms4Nw","e":"AQAB"}]}')},function(e,t){e.exports=require("node-jose@2.0.0")},function(e,t){e.exports=require("jose@4.10.0")},function(e,t){e.exports=require("axios@0.27.2")},function(e,t){e.exports=require("uuid@8.3.1")},function(e,t){e.exports=require("querystring")},function(e,t){e.exports=require("dotenv@16.0.1")},function(e,t){e.exports=require("crypto")}]);